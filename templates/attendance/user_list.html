{% extends 'base.html' %}
{% load jformat %}

{% block title %}مدیریت کاربران{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <h2 style="margin: 0;">مدیریت کاربران</h2>
    <a href="{% url 'attendance:user_create' %}" class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <i class="fas fa-user-plus"></i> افزودن کاربر جدید
    </a>
</div>

<div class="search-box">
    <form method="get">
        <select name="role" style="max-width: 200px; display: inline-block; margin-left: 10px;">
            <option value="">همه نقش‌ها</option>
            {% for role_value, role_label in role_choices %}
            <option value="{{ role_value }}" {% if role_filter == role_value %}selected{% endif %}>
                {{ role_label }}
            </option>
            {% endfor %}
        </select>
        <input type="text" name="search" placeholder="جستجو (نام کاربری، ایمیل، نام، نام خانوادگی، شماره تلفن)..." value="{{ search_query }}" style="max-width: 300px; display: inline-block; margin-left: 10px;">
        <button type="submit" class="btn">جستجو</button>
        {% if search_query or role_filter %}
        <a href="{% url 'attendance:user_list' %}" class="btn">پاک کردن فیلتر</a>
        {% endif %}
    </form>
</div>

<div class="table-wrapper">
<table>
    <thead>
        <tr>
            <th>نام کاربری</th>
            <th>نام</th>
            <th>نام خانوادگی</th>
            <th>ایمیل</th>
            <th>شماره تلفن</th>
            <th>نقش</th>
            <th>وضعیت</th>
            <th>تاریخ عضویت</th>
            <th>عملیات</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.first_name|default:"-" }}</td>
            <td>{{ user.last_name|default:"-" }}</td>
            <td>{{ user.email|default:"-" }}</td>
            <td>
                {% if user.profile.phone_number %}
                    {{ user.profile.phone_number }}
                {% else %}
                    <span style="color: #6c757d;">-</span>
                {% endif %}
            </td>
            <td>
                {% if user.profile %}
                    {{ user.profile.get_role_display }}
                {% else %}
                    <span style="color: #dc3545;">ندارد</span>
                {% endif %}
            </td>
            <td>
                {% if user.is_active %}
                    <span style="color: #28a745; font-weight: bold;">فعال</span>
                {% else %}
                    <span style="color: #dc3545; font-weight: bold;">غیرفعال</span>
                {% endif %}
            </td>
            <td>{{ user.date_joined|jformat:"%Y/%m/%d" }}</td>
            <td>
                <a href="{% url 'attendance:user_edit' user.id %}" class="btn" style="padding: 8px 15px; font-size: 14px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <i class="fas fa-edit"></i> ویرایش
                </a>
                {% if user != request.user %}
                <a href="{% url 'attendance:user_delete' user.id %}" class="btn btn-danger" style="padding: 8px 15px; font-size: 14px;">
                    <i class="fas fa-trash"></i> حذف
                </a>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" style="text-align: center; padding: 30px; color: #6c757d;">
                <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                کاربری یافت نشد
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

{% if users.has_other_pages %}
<div class="pagination">
    <div>
        {% if users.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}" class="btn">اول</a>
            <a href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}" class="btn">قبلی</a>
        {% endif %}
        
        <span class="btn" style="background: #6c757d; cursor: default;">
            صفحه {{ users.number }} از {{ users.paginator.num_pages }}
        </span>
        
        {% if users.has_next %}
            <a href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}" class="btn">بعدی</a>
            <a href="?page={{ users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}" class="btn">آخر</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

